name: Create Release Tag

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ["1.22.x", "1.23.x", "1.24.x", "1.25.x", "stable"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: gofmt (check)
        run: make fmt-check

      - name: go vet
        run: make lint

      - name: go test
        run: make test

  release:
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest tag
        id: get_tag
        run: |
          # Fetch all tags
          git fetch --tags --force
          
          # Get the latest tag (sorted by version)
          LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No existing tags found, starting at v0.1.0"
            CURRENT_VERSION="0.1.0"
          else
            # Extract version number (remove 'v' prefix)
            CURRENT_VERSION="${LATEST_TAG#v}"
            echo "Latest tag: $LATEST_TAG (version: $CURRENT_VERSION)"
          fi
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: calc_version
        run: |
          CURRENT_VERSION="${{ steps.get_tag.outputs.current_version }}"
          VERSION_TYPE="${{ github.event.inputs.version_type }}"
          
          # Parse current version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Bump version based on type
          case "$VERSION_TYPE" in
            major)
              NEW_MAJOR=$((MAJOR + 1))
              NEW_MINOR=0
              NEW_PATCH=0
              ;;
            minor)
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$((MINOR + 1))
              NEW_PATCH=0
              ;;
            patch)
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$MINOR
              NEW_PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
          NEW_TAG="v${NEW_VERSION}"
          
          echo "Bumping $VERSION_TYPE version: $CURRENT_VERSION -> $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Create and push tag
        run: |
          NEW_TAG="${{ steps.calc_version.outputs.new_tag }}"
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          
          # Check if tag already exists
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "Error: Tag $NEW_TAG already exists!"
            exit 1
          fi
          
          # Create annotated tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          
          # Push tag
          git push origin "$NEW_TAG"
          
          echo "âœ… Created and pushed tag: $NEW_TAG"

      - name: Trigger Go proxy update
        run: |
          NEW_TAG="${{ steps.calc_version.outputs.new_tag }}"
          PROXY_URL="https://proxy.golang.org/github.com/montanaflynn/grail/@v/${NEW_TAG}.info"
          echo "Triggering Go proxy update: $PROXY_URL"
          # Try curl first, fallback to wget if curl is not available
          if command -v curl > /dev/null 2>&1; then
            curl -s "$PROXY_URL" > /dev/null || echo "Warning: Failed to trigger Go proxy update"
          elif command -v wget > /dev/null 2>&1; then
            wget -q -O /dev/null "$PROXY_URL" || echo "Warning: Failed to trigger Go proxy update"
          else
            echo "Warning: Neither curl nor wget available, skipping Go proxy update"
          fi
          echo "âœ… Triggered Go proxy and documentation update"

      - name: Summary
        run: |
          echo "## Release Tag Created ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous version**: ${{ steps.get_tag.outputs.latest_tag || 'none' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New version**: ${{ steps.calc_version.outputs.new_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bump type**: ${{ github.event.inputs.version_type }}" >> $GITHUB_STEP_SUMMARY

  changelog:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install git-chglog
        run: go install github.com/git-chglog/git-chglog/cmd/git-chglog@latest

      - name: Generate Changelog
        run: |
          export PATH="$(go env GOPATH)/bin:$PATH"
          # Verify git-chglog is installed
          git-chglog --version
          # Ensure config exists
          if [ ! -f .chglog/config.yml ]; then
            git-chglog --init
          fi
          # Fetch all tags
          git fetch --tags --force
          # List tags for debugging
          echo "Available tags:"
          git tag -l
          # Verify git is working
          git --version
          # Generate changelog
          git-chglog -o CHANGELOG.md

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Ensure we're on main branch
          git checkout main || git checkout -b main
          git add CHANGELOG.md
          if git diff --staged --quiet; then
            echo "No changelog updates"
          else
            git commit -m "ci: update changelog"
            git push origin main
          fi

